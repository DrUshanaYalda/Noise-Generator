<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noise Settings Helper</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#e7eef7;
      --muted:#9fb0c3;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;

      --warn:#ffd166;
      --warnbg:rgba(255, 209, 102, 0.10);

      --pinkbg: rgba(217, 70, 239, 0.12);
      --pinkbd: rgba(217, 70, 239, 0.22);
      --brownbg: rgba(245, 158, 11, 0.12);
      --brownbd: rgba(245, 158, 11, 0.22);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Naskh Arabic", "Noto Sans Arabic", sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(110,231,255,.12), transparent),
        radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.10), transparent),
        var(--bg);
      color:var(--text);
      padding:16px;
    }

    .wrap{max-width:920px;margin:0 auto;display:flex;flex-direction:column;gap:14px}

    header{
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
      padding:10px 6px 0 6px;
    }
    h1{margin:0;font-size:20px}
    .sub{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.4;max-width:760px}

    .langbtn{
      width:auto;padding:10px 12px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(17,24,36,.55);
      color:var(--text);
      cursor:pointer;
      font-weight:850;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px;display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}

    select, button{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(17,24,36,.75);
      color:var(--text);
      outline:none;
      font-size:14px;
    }

    button{
      border:none;
      cursor:pointer;
      font-weight:950;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      color:#071018;
    }
    button.secondary{
      background: rgba(17,24,36,.75);
      border:1px solid var(--border);
      color:var(--text);
      font-weight:850;
    }

    /* Inline warning (fade in/out) */
    .alert{
      display:none;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,24,36,.55);
      color: var(--text);
      font-size:13px;
      line-height:1.45;
      opacity:0;
      transform: translateY(-4px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .alert.show{display:block;opacity:1;transform:translateY(0)}
    .alert.warn{border-color: rgba(255,209,102,.25); background: var(--warnbg);}
    .alert .tag{font-weight:950;color:var(--warn)}
    .small{font-size:12px;color:var(--muted);line-height:1.45;margin-top:6px}

    /* Goals accordion */
    .accordion{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    details{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(17,24,36,.30);
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:950;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}

    .optgrid{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .opt{
      border:1px solid var(--border);
      background: rgba(17,24,36,.55);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .opt:active{transform:scale(.98)}
    .opt.active{
      border-color: rgba(110,231,255,.65);
      background: rgba(110,231,255,.10);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10) inset;
    }

    .subopts{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(17,24,36,.35);
      display:none;
    }
    .subopts.show{display:block}

    /* Result */
    .result{display:none;flex-direction:column;gap:12px}
    .big{display:flex;gap:10px;flex-wrap:wrap}
    .metric{
      flex:1 1 240px;
      background: rgba(17,24,36,.60);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .metric .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .metric .v{font-size:18px;font-weight:950}

    .swatchWrap{display:flex;align-items:center;gap:10px}
    .swatch{
      width:22px;height:22px;border-radius:7px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .swatch.brown{background: var(--brownbg); border-color: var(--brownbd);}
    .swatch.pink{background: var(--pinkbg); border-color: var(--pinkbd);}

    .box{
      background: rgba(17,24,36,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      font-size:13px;
      line-height:1.6;
    }
    .box h3{
      margin:0 0 8px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:900;
    }
    .box.warn{
      border-color: rgba(255,209,102,.25);
      background: var(--warnbg);
    }
    .warnTitle{color:var(--warn);font-weight:950}

    /* Footer signature subtle */
    .footer{
      display:flex;justify-content:center;gap:10px;flex-wrap:wrap;
      font-size:12px;color:rgba(159,176,195,.85);
      text-align:center;padding:6px 8px;
    }
    .creator{
      font-size:11px;
      opacity:.22;
      font-weight:500;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(17,24,36,.18);
      color: rgba(200,220,245,.75);
      white-space:nowrap;
    }

    html[dir="rtl"] .swatchWrap{flex-direction:row-reverse;justify-content:flex-end}
    html[dir="rtl"] .optgrid{justify-content:flex-start}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="t_title">إعدادات Noise Generator</h1>
        <div class="sub" id="t_sub">
          هذا الموقع يعطيك الأرقام التي تضعها في تطبيق Noise Generator.<br>
          اختر ما تريد الآن، وستظهر لك الإعدادات المناسبة.
        </div>
      </div>
      <button class="langbtn" id="btnLang">English</button>
    </header>

    <div class="card">
      <div class="row">
        <div class="col">
          <label id="t_age">العمر؟</label>
          <select id="age"></select>
        </div>

        <div class="col">
          <label id="t_device">أي جهاز ستستخدم للصوت؟</label>
          <select id="device"></select>
          <div class="alert" id="warnDevice"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label id="t_distance">المسافة بينك وبين الجهاز؟</label>
          <select id="distance"></select>
          <div class="alert" id="warnDistance"></div>
        </div>

        <div class="col">
          <label id="t_convToggle">هل تريد تركيز في المحادثة وسماع الكلام بوضوح؟</label>
          <select id="convToggle"></select>
          <div class="small" id="t_convHint"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label id="t_sensitive">هل الصوت يضايقك أو يسبب لك انزعاج اليوم؟</label>
          <select id="sensitive"></select>
          <div class="alert" id="warnSensitive"></div>
        </div>

        <div class="col">
          <label id="t_sleepMeds">هل تأخذ دواء يساعدك على النوم أو يجعلك تنعس؟</label>
          <select id="sleepMeds"></select>
          <div class="alert" id="warnMeds"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label id="t_infantRoom">هل يوجد رضيع أقل من سنة ونصف في نفس الغرفة؟</label>
          <select id="infantRoom"></select>
          <div class="alert warn" id="warnInfant"></div>
        </div>

        <div class="col">
          <label id="t_goalsTitle">اختر ما تريد الآن:</label>
          <div class="accordion" id="goals"></div>

          <div class="subopts" id="subChoiceBox">
            <div id="subChoiceTitle" style="font-weight:950;margin-bottom:8px"></div>
            <div class="optgrid" id="subChoices"></div>
          </div>

          <div class="small" id="t_goalHint"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col"><button id="btnGet">أعطني الإعدادات</button></div>
        <div class="col"><button class="secondary" id="btnReset">إعادة ضبط</button></div>
      </div>

      <details style="margin-top:10px">
        <summary id="t_medNoteTitle">ملاحظة طبية (مهم)</summary>
        <div class="small" id="t_medNoteBody" style="margin-top:8px">
          الأمان يعتمد أساسًا على مستوى الصوت والمسافة (خصوصًا للرضّع). نطاقات التردد هنا قواعد عملية وليست وصفة طبية.
          إذا سبب الصوت انزعاجًا، خفّض الصوت أو توقف.
        </div>
      </details>
    </div>

    <div class="card result" id="result">
      <div class="big">
        <div class="metric">
          <div class="k" id="t_outColorK">لون الصوت</div>
          <div class="v">
            <div class="swatchWrap">
              <span class="swatch" id="swatch"></span>
              <span id="outColor">—</span>
            </div>
          </div>
        </div>

        <div class="metric">
          <div class="k" id="t_outLowK">Low cut</div>
          <div class="v" id="outLow">—</div>
        </div>

        <div class="metric">
          <div class="k" id="t_outHighK">High cut</div>
          <div class="v" id="outHigh">—</div>
        </div>
      </div>

      <div class="box" id="boxVolume">
        <h3 id="t_volumeTitle">مستوى الصوت</h3>
        <div id="outVolume">—</div>
      </div>

      <div class="box" id="boxAdjust">
        <h3 id="t_adjustTitle">إذا لم يناسبك:</h3>
        <div id="outAdjust">ارفع Low cut قليلاً أو خفّض High cut.</div>
      </div>

      <div class="box warn" id="boxNotice" style="display:none">
        <div class="warnTitle" id="t_noticeTitle">تنبيه مهم</div>
        <div style="margin-top:6px" id="outNotice"></div>
      </div>
    </div>

    <div class="footer">
      <span id="t_footer">كل خطوة... لنا.</span>
      <span class="creator" id="t_creator">د. اوشانا يلده</span>
    </div>
  </div>

<script>
/* =========================
   State
========================= */
const state = {
  lang: "ar",
  age: "adult",
  device: "phone",
  distance: "normal",
  infantRoom: "no",
  convToggle: "no",
  sensitive: "no",
  sleepMeds: "no",
  goal: null,
  goalSub: null
};

/* =========================
   i18n
========================= */
const I18N = {
  ar: {
    langBtn: "English",
    title: "إعدادات Noise Generator",
    sub: "هذا الموقع يعطيك الأرقام التي تضعها في تطبيق Noise Generator.<br>اختر ما تريد الآن، وستظهر لك الإعدادات المناسبة.",
    age: "العمر؟",
    device: "أي جهاز ستستخدم للصوت؟",
    distance: "المسافة بينك وبين الجهاز؟",
    infantRoom: "هل يوجد رضيع أقل من سنة ونصف في نفس الغرفة؟",
    convToggle: "هل تريد تركيز في المحادثة وسماع الكلام بوضوح؟",
    convHint: "إذا «نعم»، النظام يقلل تمويه الكلام.",
    sensitive: "هل الصوت يضايقك أو يسبب لك انزعاج اليوم؟",
    sleepMeds: "هل تأخذ دواء يساعدك على النوم أو يجعلك تنعس؟",
    goalsTitle: "اختر ما تريد الآن:",
    goalHint: "اختر خيار واحد فقط.",
    get: "أعطني الإعدادات",
    reset: "إعادة ضبط",
    medNoteTitle: "ملاحظة طبية (مهم)",
    medNoteBody: "الأمان يعتمد أساسًا على مستوى الصوت والمسافة (خصوصًا للرضّع). نطاقات التردد هنا قواعد عملية وليست وصفة طبية. إذا سبب الصوت انزعاجًا، خفّض الصوت أو توقف.",
    outColorK: "لون الصوت",
    outLowK: "Low cut",
    outHighK: "High cut",
    volumeTitle: "مستوى الصوت",
    adjustTitle: "إذا لم يناسبك:",
    adjustText: "ارفع Low cut قليلاً أو خفّض High cut.",
    noticeTitle: "تنبيه مهم",
    footer: "كل خطوة... لنا.",
    creator: "د. اوشانا يلده",

    options: {
      age: [
        ["adult","بالغ"],
        ["older","كبير سن"],
        ["child","طفل"],
        ["toddler","طفل صغير"],
        ["infant","رضيع"]
      ],
      device: [
        ["phone","سماعة الهاتف"],
        ["tablet","سماعة التابلت"],
        ["external","Bluetooth speaker"],
        ["headphones","AirPods / Headphones"]
      ],
      distance: [
        ["near","أقل من 0.5 متر"],
        ["normal","بين 0.5 و 1.5 متر"],
        ["far","أكثر من 1.5 متر"]
      ],
      yesno: [
        ["no","لا"],
        ["yes","نعم"]
      ]
    },

    goalSections: [
      { key:"rest", title:"الراحة والنوم", items:[
        {key:"sleep", label:"نوم"},
        {key:"relax", label:"راحة وهدوء (Relaxation)"},
        {key:"muscle", label:"راحة العضلات"}
      ]},
      { key:"think", title:"التفكير والتركيز", items:[
        {key:"quiet", label:"تهدئة الأفكار"},
        {key:"focus", label:"تركيز في العمل"},
        {key:"study", label:"دراسة"},
        {key:"conv", label:"تركيز في المحادثة"}
      ]},
      { key:"daily", title:"أنشطة يومية", items:[
        {key:"cook", label:"طبخ"},
        {key:"clean", label:"تنظيف أو ترتيب"},
        {key:"sew", label:"خياطة أو عمل يدوي"}
      ]},
      { key:"fun", title:"نشاط وترفيه", items:[
        {key:"game", label:"ألعاب فيديو"},
        {key:"tv", label:"مشاهدة تلفاز"}
      ]},
      { key:"kids", title:"مع الأطفال", items:[
        {key:"childCalm", label:"تهدئة الطفل"},
        {key:"childFocus", label:"مساعدة الطفل على التركيز"},
        {key:"childSleep", label:"نوم الطفل"}
      ]}
    ],

    subChoices: {
      quiet: {
        title: "تهدئة الأفكار — اختر النوع:",
        items: [
          {key:"quiet_full", label:"هدوء كامل"},
          {key:"quiet_light", label:"هدوء مع طاقة خفيفة"}
        ]
      },
      game: {
        title: "ألعاب فيديو — اختر النوع:",
        items: [
          {key:"game_calm", label:"هدوء أثناء اللعب"},
          {key:"game_comp", label:"تركيز وتنافس"}
        ]
      }
    },

    warnings: {
      headphonesDistance: "عند استخدام AirPods / Headphones، المسافة لا تغيّر النتيجة.",
      nearSpeaker: "إذا سمعت طنين أو اهتزاز، ارفع Low cut بمقدار 20 Hz.",
      sensitive: "إذا صار الصوت مزعج، خفّض High cut بمقدار 100 Hz.",
      medsSleep: "هذا الاختيار يؤثر فقط على وضع النوم.",
      infant: "إذا يوجد رضيع: اجعل الصوت منخفض جداً، والجهاز على بعد 1–2 متر، ولا تستخدم AirPods للرضيع."
    },

    volumeByGoal: {
      sleep:        "تخيل الصوت مثل هواء خفيف في الغرفة.<br>لا يضغط عليك ولا يشد انتباهك.",
      relax:        "تخيل الصوت جزءاً من خلفية المكان.<br>موجود… لكنه لا يطلب انتباهك.",
      muscle:       "تخيل الصوت يحيط بجسمك برفق.<br>إذا شعرت بثقل في صدرك أو رأسك، خفّضه.",
      quiet_full:   "اجعل الصوت أهدأ من أفكارك.<br>إذا لاحظته بوضوح، خفّضه قليلاً.",
      quiet_light:  "ليكن الصوت منظمًا وهادئًا.<br>يساعدك على التركيز دون أن يربكك.",
      focus:        "ليكن الصوت خلفية ثابتة.<br>يساعدك على الاستمرار دون أن يغطي ما حولك.",
      study:        "ليكن الصوت ثابتًا ومريحًا.<br>يُبقيك منتبهًا دون إجهاد.",
      cook:         "الصوت يجب أن يبقيك يقظًا.<br>لا تجعله أعلى من أصوات المطبخ.",
      clean:        "ليكن الصوت نشيطًا لكن غير مزعج.<br>إذا بدأ يلفت انتباهك، خفّضه.",
      sew:          "الصوت يجب أن يساعدك على الدقة.<br>إذا أحسست بتوتر، خفّضه.",
      game_calm:    "ليكن الصوت خلفية فقط.<br>لا يغطي صوت اللعبة.",
      game_comp:    "الصوت يجب أن يزيد يقظتك بلطف.<br>إذا شعرت بضغط، خفّضه.",
      tv:           "الصوت يجب أن يبقى خلف الحوار.<br>إذا غطى على الكلام، خفّضه.",
      childCalm:    "ليكن الصوت لطيفًا كهواء خفيف.<br>لا ترفعه حتى لو لم يهدأ الطفل فورًا.",
      childFocus:   "منخفض ومعتدل.<br>يجب أن يساعد الطفل دون أن يشتته.",
      childSleep:   "الصوت يجب أن يكون أهدأ من تنفس الطفل.<br>إذا لاحظته بوضوح، خفّضه.",
      infantOverride:"الصوت يجب أن يكون خفيفًا جدًا.<br>ضع الجهاز بعيدًا 1–2 متر."
    },

    olderExtra: "ابدأ منخفض، ثم ارفعه خطوة صغيرة إذا لم تسمعه.<br>لا تجعله قويًا أو مزعجًا."
  },

  en: {
    langBtn: "العربية",
    title: "Noise Settings Helper",
    sub: "This page tells you what numbers to use in the Noise Generator app.<br>Choose what you need, and the right settings will appear.",
    age: "Age",
    device: "Which device will play the sound?",
    distance: "How far is the device from you?",
    infantRoom: "Is there an infant under 1.5 years in the same room?",
    convToggle: "Do you want clear conversation focus (hear speech clearly)?",
    convHint: "If “Yes”, we avoid heavy masking of speech.",
    sensitive: "Is sound bothering you today?",
    sleepMeds: "Are you taking medicine that makes you sleepy?",
    goalsTitle: "Choose what you need now:",
    goalHint: "Choose one option only.",
    get: "Get settings",
    reset: "Reset",
    medNoteTitle: "Medical note (important)",
    medNoteBody: "Safety is mainly about volume and distance (especially for infants). Frequency bands here are practical starting presets, not a medical prescription. If anything feels uncomfortable, lower volume or stop.",
    outColorK: "Color",
    outLowK: "Low cut",
    outHighK: "High cut",
    volumeTitle: "Volume level",
    adjustTitle: "If it doesn’t feel right:",
    adjustText: "Raise Low cut slightly or lower High cut.",
    noticeTitle: "Important notice",
    footer: "Each step… ours.",
    creator: "Dr Ushana Yalda",

    options: {
      age: [
        ["adult","Adult"],
        ["older","Older adult"],
        ["child","Child"],
        ["toddler","Toddler"],
        ["infant","Infant"]
      ],
      device: [
        ["phone","Phone speaker"],
        ["tablet","Tablet speaker"],
        ["external","Bluetooth speaker"],
        ["headphones","AirPods / Headphones"]
      ],
      distance: [
        ["near","Under 0.5 m"],
        ["normal","0.5–1.5 m"],
        ["far","Over 1.5 m"]
      ],
      yesno: [
        ["no","No"],
        ["yes","Yes"]
      ]
    },

    goalSections: [
      { key:"rest", title:"Rest & sleep", items:[
        {key:"sleep", label:"Sleep"},
        {key:"relax", label:"Relaxation"},
        {key:"muscle", label:"Muscle relaxation"}
      ]},
      { key:"think", title:"Thinking & focus", items:[
        {key:"quiet", label:"Quiet my thoughts"},
        {key:"focus", label:"Focus at work"},
        {key:"study", label:"Study"},
        {key:"conv", label:"Focus during conversation"}
      ]},
      { key:"daily", title:"Daily activities", items:[
        {key:"cook", label:"Cooking"},
        {key:"clean", label:"Cleaning / organizing"},
        {key:"sew", label:"Sewing / hand work"}
      ]},
      { key:"fun", title:"Entertainment", items:[
        {key:"game", label:"Video games"},
        {key:"tv", label:"Watching TV"}
      ]},
      { key:"kids", title:"With children", items:[
        {key:"childCalm", label:"Calm a child"},
        {key:"childFocus", label:"Help a child focus"},
        {key:"childSleep", label:"Child sleep"}
      ]}
    ],

    subChoices: {
      quiet: {
        title: "Quiet my thoughts — choose:",
        items: [
          {key:"quiet_full", label:"Full calm"},
          {key:"quiet_light", label:"Calm + light energy"}
        ]
      },
      game: {
        title: "Video games — choose:",
        items: [
          {key:"game_calm", label:"Calm while playing"},
          {key:"game_comp", label:"Competitive focus"}
        ]
      }
    },

    warnings: {
      headphonesDistance: "With AirPods / Headphones, distance does not change the result.",
      nearSpeaker: "If you hear buzzing/rumble, raise Low cut by 20 Hz.",
      sensitive: "If it feels annoying, lower High cut by 100 Hz.",
      medsSleep: "This affects Sleep mode only.",
      infant: "If an infant is present: keep volume very low, device 1–2 m away, and do not use AirPods for infants."
    },

    volumeByGoal: {
      sleep:         "Imagine it like light air in the room.<br>No pressure. No pulling your attention.",
      relax:         "Let it be part of the background.<br>Present… but not demanding attention.",
      muscle:        "Let it sit around your body gently.<br>If you feel heaviness, lower it.",
      quiet_full:    "Keep it quieter than your thoughts.<br>If you notice it clearly, lower it slightly.",
      quiet_light:   "Low but steady.<br>It should organize you, not distract you.",
      focus:         "A steady background.<br>Supports focus without covering important sounds.",
      study:         "Steady and comfortable.<br>Helps you continue without strain.",
      cook:          "Helps you stay alert.<br>Don’t make it louder than kitchen sounds.",
      clean:         "Active but not annoying.<br>If it grabs attention, lower it.",
      sew:           "Supports precision.<br>If you feel tense, lower it.",
      game_calm:     "Background only.<br>Do not cover the game audio.",
      game_comp:     "Gently increases alertness.<br>If it feels like pressure, lower it.",
      tv:            "Behind the dialogue.<br>If it covers speech, lower it.",
      childCalm:     "Gentle like light air.<br>Don’t raise it quickly.",
      childFocus:    "Low and moderate.<br>Helps the child without distraction.",
      childSleep:    "Quieter than the child’s breathing.<br>If you notice it clearly, lower it.",
      infantOverride:"Very gentle.<br>Keep device 1–2 m away."
    },

    olderExtra: "Start low, then raise one small step if you can’t hear it.<br>Don’t make it loud."
  }
};

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);

function setLang(newLang){
  state.lang = newLang;
  document.documentElement.lang = (newLang === "ar" ? "ar" : "en");
  document.documentElement.dir  = (newLang === "ar" ? "rtl" : "ltr");
  renderAll();
  persist();
}

function fillSelect(el, options, value){
  el.innerHTML = "";
  for(const [v, t] of options){
    const o = document.createElement("option");
    o.value = v; o.textContent = t;
    el.appendChild(o);
  }
  el.value = value;
}

function showAlert(el, text, kind="warn"){
  el.classList.add(kind);
  el.innerHTML = `<span class="tag">${(state.lang==="ar" ? "تنبيه:" : "Note:")}</span> ${escapeHtml(text)}`;
  el.classList.add("show");
}
function hideAlert(el){
  el.classList.remove("show","warn","bad");
  el.innerHTML = "";
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* =========================
   Base ranges (final)
========================= */
const BASE = {
  // Rest & sleep
  sleep:  { color:"brown", low:100, high:700 },
  relax:  { color:"brown", low:120, high:900 },
  muscle: { color:"brown", low:130, high:750 },

  // Thinking & focus
  quiet_full:  { color:"brown", low:150, high:600 },
  quiet_light: { color:"pink",  low:170, high:900 },

  focus:  { color:"pink",  low:160, high:1500 },
  study:  { color:"pink",  low:160, high:1300 },
  conv:   { color:"pink",  low:180, high:1100 },

  // Daily
  cook:   { color:"pink",  low:170, high:1700 },
  clean:  { color:"pink",  low:180, high:1800 },
  sew:    { color:"pink",  low:160, high:1300 },

  // Entertainment
  game_calm: { color:"brown", low:150, high:900 },
  game_comp: { color:"pink",  low:180, high:1800 },
  tv:        { color:"pink",  low:180, high:1100 },

  // Kids
  childCalm:  { color:"brown", low:150, high:700 },
  childFocus: { color:"pink",  low:170, high:1200 },
  childSleep: { color:"brown", low:120, high:600 }
};

function deviceFloor(device){
  switch(device){
    case "phone": return 150;
    case "tablet": return 110;
    case "external": return 80;
    case "headphones": return 50;
    default: return 150;
  }
}

/* =========================
   Recommendation engine
========================= */
function resolveGoalKey(){
  let goalKey = state.goal;

  if(goalKey === "quiet"){
    goalKey = state.goalSub || "quiet_full";
  }
  if(goalKey === "game"){
    goalKey = state.goalSub || "game_comp";
  }
  if(!goalKey || !BASE[goalKey]) return null;
  return goalKey;
}

function recommend(){
  const goalKey = resolveGoalKey();
  if(!goalKey) return null;

  let {color, low, high} = BASE[goalKey];

  // device floor
  const floor = deviceFloor(state.device);
  low = Math.max(low, floor);

  // distance modifiers (speakers only)
  if(state.device !== "headphones"){
    if(state.distance === "near") low = Math.max(low, floor + 20);
    if(state.distance === "far") high = high + 100;
  }

  // conversation clarity toggle (global)
  if(state.convToggle === "yes"){
    high = Math.min(high, 1200);
  }

  // sensitivity today
  if(state.sensitive === "yes"){
    high = Math.min(high, 900);
  }

  // sleep meds: only sleep-like
  if(state.sleepMeds === "yes" && (goalKey === "sleep" || goalKey === "childSleep")){
    high = Math.min(high, 700);
  }

  // older adult smoothing
  if(state.age === "older"){
    high = Math.min(high, 900);
  }

  // toddler constraints
  if(state.age === "toddler"){
    high = Math.min(high, 700);
    low = Math.max(low, floor);
  }

  // child cap
  if(state.age === "child"){
    high = Math.min(high, 1200);
  }

  // infant safety override
  if(state.infantRoom === "yes" || state.age === "infant"){
    color = "brown";
    low = Math.max(150, floor);
    high = 550;
  }

  if(high - low < 300) high = low + 300;

  return { goalKey, color, low, high };
}

/* =========================
   Volume text + Notice
========================= */
function volumeText(rec){
  const t = I18N[state.lang];

  // infant override dominates
  if(state.infantRoom === "yes" || state.age === "infant"){
    return t.volumeByGoal.infantOverride;
  }

  // base volume by goal
  const v = t.volumeByGoal[rec.goalKey] || t.volumeByGoal.focus;

  // older adults: append gentle practical extra (still two lines style)
  if(state.age === "older"){
    // keep sensory text, add practical extra below as a second block
    return `${v}<br><br>${t.olderExtra}`;
  }

  return v;
}

function buildNotice(){
  const notices = [];
  if(state.infantRoom === "yes" || state.age === "infant"){
    notices.push(I18N[state.lang].warnings.infant);
  }
  return notices;
}

/* =========================
   Rendering
========================= */
function renderAll(){
  const t = I18N[state.lang];

  $("btnLang").textContent = t.langBtn;
  $("t_title").textContent = t.title;
  $("t_sub").innerHTML = t.sub;

  $("t_age").textContent = t.age;
  $("t_device").textContent = t.device;
  $("t_distance").textContent = t.distance;
  $("t_infantRoom").textContent = t.infantRoom;
  $("t_convToggle").textContent = t.convToggle;
  $("t_convHint").textContent = t.convHint;
  $("t_sensitive").textContent = t.sensitive;
  $("t_sleepMeds").textContent = t.sleepMeds;
  $("t_goalsTitle").textContent = t.goalsTitle;
  $("t_goalHint").textContent = t.goalHint;

  $("btnGet").textContent = t.get;
  $("btnReset").textContent = t.reset;

  $("t_medNoteTitle").textContent = t.medNoteTitle;
  $("t_medNoteBody").textContent = t.medNoteBody;

  $("t_outColorK").textContent = t.outColorK;
  $("t_outLowK").textContent = t.outLowK;
  $("t_outHighK").textContent = t.outHighK;

  $("t_volumeTitle").textContent = t.volumeTitle;
  $("t_adjustTitle").textContent = t.adjustTitle;
  $("outAdjust").textContent = t.adjustText;
  $("t_noticeTitle").textContent = t.noticeTitle;

  $("t_footer").textContent = t.footer;
  $("t_creator").textContent = t.creator;

  fillSelect($("age"), t.options.age, state.age);
  fillSelect($("device"), t.options.device, state.device);
  fillSelect($("distance"), t.options.distance, state.distance);
  fillSelect($("infantRoom"), t.options.yesno, state.infantRoom);
  fillSelect($("convToggle"), t.options.yesno, state.convToggle);
  fillSelect($("sensitive"), t.options.yesno, state.sensitive);
  fillSelect($("sleepMeds"), t.options.yesno, state.sleepMeds);

  renderGoals();
  refreshInlineWarnings();

  if($("result").style.display === "flex"){
    renderResult();
  }
}

function renderGoals(){
  const t = I18N[state.lang];
  const container = $("goals");
  container.innerHTML = "";

  t.goalSections.forEach((sec, idx) => {
    const det = document.createElement("details");
    det.dataset.key = sec.key;
    if(!state.goal && idx === 0) det.open = true;

    const sum = document.createElement("summary");
    sum.textContent = sec.title;
    det.appendChild(sum);

    const grid = document.createElement("div");
    grid.className = "optgrid";

    sec.items.forEach(item => {
      const b = document.createElement("div");
      b.className = "opt" + (state.goal === item.key ? " active" : "");
      b.textContent = item.label;
      b.onclick = () => {
        state.goal = item.key;
        state.goalSub = null;

        closeAllDetailsExcept(det);
        maybeShowSubChoices(item.key);
        renderGoals();

        $("result").style.display = "none";
        persist();
      };
      grid.appendChild(b);
    });

    det.appendChild(grid);

    det.addEventListener("toggle", () => {
      if(det.open) closeAllDetailsExcept(det);
    });

    container.appendChild(det);
  });

  maybeShowSubChoices(state.goal);
}

function closeAllDetailsExcept(openDet){
  const all = $("goals").querySelectorAll("details");
  all.forEach(d => { if(d !== openDet) d.open = false; });
}

function maybeShowSubChoices(goalKey){
  const t = I18N[state.lang];
  const box = $("subChoiceBox");
  const title = $("subChoiceTitle");
  const list = $("subChoices");

  if(goalKey !== "quiet" && goalKey !== "game"){
    box.classList.remove("show");
    title.textContent = "";
    list.innerHTML = "";
    return;
  }

  const cfg = t.subChoices[goalKey];
  title.textContent = cfg.title;
  list.innerHTML = "";

  cfg.items.forEach((it, i) => {
    const active = (state.goalSub === it.key) || (!state.goalSub && i === 0);
    const b = document.createElement("div");
    b.className = "opt" + (active ? " active" : "");
    b.textContent = it.label;
    b.onclick = () => {
      state.goalSub = it.key;
      maybeShowSubChoices(goalKey);
      $("result").style.display = "none";
      persist();
    };
    list.appendChild(b);
  });

  if(!state.goalSub) state.goalSub = cfg.items[0].key;

  box.classList.add("show");
}

/* =========================
   Inline warnings
========================= */
function refreshInlineWarnings(){
  const t = I18N[state.lang];

  if(state.device === "headphones"){
    showAlert($("warnDevice"), t.warnings.headphonesDistance, "warn");
  } else {
    hideAlert($("warnDevice"));
  }

  if(state.device !== "headphones" && state.distance === "near"){
    showAlert($("warnDistance"), t.warnings.nearSpeaker, "warn");
  } else {
    hideAlert($("warnDistance"));
  }

  if(state.sensitive === "yes"){
    showAlert($("warnSensitive"), t.warnings.sensitive, "warn");
  } else {
    hideAlert($("warnSensitive"));
  }

  if(state.sleepMeds === "yes"){
    showAlert($("warnMeds"), t.warnings.medsSleep, "warn");
  } else {
    hideAlert($("warnMeds"));
  }

  if(state.infantRoom === "yes" || state.age === "infant"){
    $("warnInfant").classList.add("show");
    $("warnInfant").innerHTML = `<span class="tag">${state.lang==="ar" ? "تنبيه:" : "Note:"}</span> ${escapeHtml(t.warnings.infant)}`;
  } else {
    hideAlert($("warnInfant"));
  }
}

/* =========================
   Result rendering
========================= */
function renderResult(){
  const rec = recommend();
  if(!rec){
    $("result").style.display = "none";
    return;
  }

  const t = I18N[state.lang];

  // Color label
  const colorLabel = rec.color === "brown"
    ? (state.lang==="ar" ? "Brown (بني)" : "Brown")
    : (state.lang==="ar" ? "Pink (وردي)" : "Pink");

  $("outColor").textContent = colorLabel;
  $("outLow").textContent = `${rec.low} Hz`;
  $("outHigh").textContent = `${rec.high} Hz`;

  const sw = $("swatch");
  sw.classList.remove("brown","pink");
  sw.classList.add(rec.color);

  $("outVolume").innerHTML = volumeText(rec);

  const notices = buildNotice();
  if(notices.length){
    $("boxNotice").style.display = "block";
    $("outNotice").innerHTML = notices.map(n => `• ${escapeHtml(n)}`).join("<br>");
  }else{
    $("boxNotice").style.display = "none";
    $("outNotice").innerHTML = "";
  }

  $("result").style.display = "flex";
}

/* =========================
   Persistence
========================= */
function persist(){
  try{
    localStorage.setItem("noise_settings_helper_state_v3", JSON.stringify(state));
  }catch(e){}
}

function restore(){
  try{
    const raw = localStorage.getItem("noise_settings_helper_state_v3");
    if(!raw) return;
    const s = JSON.parse(raw);

    if(s.lang === "ar" || s.lang === "en") state.lang = s.lang;
    if(typeof s.age === "string") state.age = s.age;
    if(typeof s.device === "string") state.device = s.device;
    if(typeof s.distance === "string") state.distance = s.distance;
    if(typeof s.infantRoom === "string") state.infantRoom = s.infantRoom;
    if(typeof s.convToggle === "string") state.convToggle = s.convToggle;
    if(typeof s.sensitive === "string") state.sensitive = s.sensitive;
    if(typeof s.sleepMeds === "string") state.sleepMeds = s.sleepMeds;
    if(typeof s.goal === "string") state.goal = s.goal;
    if(typeof s.goalSub === "string") state.goalSub = s.goalSub;
  }catch(e){}
}

/* =========================
   Events
========================= */
function wire(){
  $("btnLang").onclick = () => setLang(state.lang === "ar" ? "en" : "ar");

  $("age").onchange = (e) => {
    state.age = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("device").onchange = (e) => {
    state.device = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("distance").onchange = (e) => {
    state.distance = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("infantRoom").onchange = (e) => {
    state.infantRoom = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("convToggle").onchange = (e) => {
    state.convToggle = e.target.value;
    $("result").style.display = "none";
    persist();
  };

  $("sensitive").onchange = (e) => {
    state.sensitive = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("sleepMeds").onchange = (e) => {
    state.sleepMeds = e.target.value;
    refreshInlineWarnings();
    $("result").style.display = "none";
    persist();
  };

  $("btnGet").onclick = () => {
    renderResult();
    persist();
  };

  $("btnReset").onclick = () => {
    const keepLang = state.lang;
    Object.assign(state, {
      lang: keepLang,
      age: "adult",
      device: "phone",
      distance: "normal",
      infantRoom: "no",
      convToggle: "no",
      sensitive: "no",
      sleepMeds: "no",
      goal: null,
      goalSub: null
    });
    $("result").style.display = "none";
    renderAll();
    persist();
  };
}

/* =========================
   Init
========================= */
(function init(){
  restore();
  document.documentElement.lang = (state.lang==="ar" ? "ar" : "en");
  document.documentElement.dir  = (state.lang==="ar" ? "rtl" : "ltr");
  wire();
  renderAll();
})();
</script>
</body>
</html>
