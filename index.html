<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Focus Sound Tool</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111824; --muted:#9fb0c3; --text:#e7eef7;
      --accent:#6ee7ff; --accent2:#a78bfa; --warn:#ffd166; --bad:#ff6b6b; --good:#7CFFB2;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Naskh Arabic", "Noto Sans Arabic", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(110,231,255,.18), transparent),
                  radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.18), transparent),
                  var(--bg);
      color:var(--text);
      padding:16px;
    }
    .wrap{max-width:860px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    header{display:flex;flex-direction:column;gap:8px;padding:14px 14px 2px 14px;}
    .topbar{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}
    .byline{color:rgba(159,176,195,.9);font-size:12px;margin-top:6px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 230px;display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input, select, button{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(17,24,36,.75);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:rgba(159,176,195,.75)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--border);
      background: rgba(17,24,36,.55);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .chip:active{transform:scale(.98)}
    .chip.active{
      border-color: rgba(110,231,255,.65);
      background: rgba(110,231,255,.10);
      box-shadow: 0 0 0 3px rgba(110,231,255,.10) inset;
    }
    .btn{
      cursor:pointer;
      border:none;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      color:#061018;
      font-weight:950;
      letter-spacing:.2px;
    }
    .btn.secondary{
      background: rgba(17,24,36,.75);
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
    }
    .btn.danger{
      background: rgba(255,107,107,.14);
      border:1px solid rgba(255,107,107,.35);
      color: var(--text);
      font-weight:950;
    }
    .langbtn{
      width:auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(17,24,36,.55);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      align-self:flex-start;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background: rgba(17,24,36,.55);
      width:fit-content;
    }
    .mini-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .mini-actions button{flex:1 1 240px}
    .result{display:flex;flex-direction:column;gap:10px;}
    .big{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .metric{
      flex:1 1 220px;
      background: rgba(17,24,36,.60);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .metric .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .metric .v{font-size:22px;font-weight:980}
    .hint{
      font-size:13px;line-height:1.45;color:var(--text);
      background: rgba(17,24,36,.55);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:12px;
    }
    details{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(17,24,36,.35);
      padding:10px 12px;
    }
    summary{cursor:pointer;color:var(--text);font-weight:980}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .flag{font-weight:980}
    .ok{color:var(--good)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .footer{
      font-size:12px;color:rgba(159,176,195,.85);
      text-align:center;padding:6px 8px;
    }
    .steps{
      margin-top:10px;
      display:flex;flex-direction:column;gap:8px;
      background: rgba(17,24,36,.40);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .step{display:flex;gap:10px;align-items:flex-start;font-size:13px;line-height:1.5;color:var(--text);}
    .num{
      min-width:26px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(110,231,255,.12);
      border:1px solid rgba(110,231,255,.25);
      color:var(--text);
      font-weight:980;
      margin-top:1px;
    }
    .quicktest{
      margin-top:12px;
      background: rgba(17,24,36,.40);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }
    .quicktest .qtitle{font-weight:980;margin-bottom:6px}
    .quicktest .qtext{font-size:13px;color:var(--text);line-height:1.45}
    .quicktest .qactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .quicktest .qactions button{flex:1 1 200px}
    html[dir="rtl"] .step{flex-direction:row-reverse}
    html[dir="rtl"] .quicktest .qactions{flex-direction:row-reverse}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="topbar">
        <div>
          <h1 id="t_title">Focus Sound Tool</h1>
          <div class="sub" id="t_sub">Select your situation and get a simple sound range suggestion. Works with the Noise Generator app.</div>
          <div class="byline" id="t_byline">By Dr Ushana Yalda</div>
          <div class="pill" id="t_quickStart" style="margin-top:10px">Quick start: pick an activity â†’ tap â€œGet my settingâ€.</div>
        </div>
        <button class="langbtn" id="btnLang" aria-label="Toggle language">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <div class="col">
          <label id="t_nameLabel">Name (optional)</label>
          <input id="name" placeholder="e.g., Ali / Dalila / Noor" />
          <div class="small" id="t_nameHint">Tip: add a name so this phone remembers your setup.</div>
        </div>
        <div class="col">
          <label id="t_deviceLabel">Device (optional)</label>
          <input id="device" placeholder="e.g., iPhone 11 / Xiaomi / Galaxy..." />
          <div class="small" id="t_deviceHint">Device name is for clarity. The next box drives the advice.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label id="t_setupLabel">Audio setup (this matters)</label>
          <select id="setup"></select>
          <div class="pill" id="t_setupPill">Quick rule: headphones = you can go lower ğŸ§</div>
        </div>

        <div class="col">
          <label id="t_colorLabel">Noise color</label>
          <select id="color"></select>
          <div class="small" id="t_colorHint">If unsure: choose Brown.</div>
        </div>
      </div>

      <!-- One-question setup helper -->
      <div class="quicktest" aria-label="Quick setup helper">
        <div class="qtitle" id="t_qTitle">Quick setup helper (1 question)</div>
        <div class="qtext" id="t_qText">
          Set Low cut to 80 Hz for 5 seconds. Do you clearly hear a difference?
          <div class="small" style="margin-top:6px" id="t_qNote">
            If you are using headphones/earbuds now, skip this (choose â€œHeadphones / earbudsâ€ above).
          </div>
        </div>
        <div class="qactions">
          <button class="btn secondary" id="btnQYes">Yes â†’ my speaker handles bass</button>
          <button class="btn secondary" id="btnQNo">No â†’ my speaker is weak</button>
        </div>
        <div class="small" id="qResult" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:12px">
        <label id="t_activityLabel">Pick an activity</label>
        <div class="chips" id="chips"></div>
        <div class="small" id="t_activityHint" style="margin-top:8px">Choose one. Keep it simple.</div>
      </div>

      <div class="mini-actions">
        <button class="btn" id="btnSuggest">Get my setting</button>
        <button class="btn secondary" id="btnSave">Save my profile</button>
        <button class="btn danger" id="btnReset">Reset (clear saved)</button>
      </div>

      <div class="small" id="t_autoSaveNote" style="margin-top:10px">
        Note: â€œGet my settingâ€ also auto-saves your last choices on this phone.
      </div>
    </div>

    <div class="card result" id="resultCard" style="display:none">
      <div class="big">
        <div class="metric">
          <div class="k" id="t_outLowK">Suggested Low cut</div>
          <div class="v" id="outLow">â€”</div>
        </div>
        <div class="metric">
          <div class="k" id="t_outHighK">Suggested High cut</div>
          <div class="v" id="outHigh">â€”</div>
        </div>
        <div class="metric">
          <div class="k" id="t_outVolK">Volume hint</div>
          <div class="v" style="font-size:16px;font-weight:950" id="outVol">â€”</div>
        </div>
      </div>

      <div class="hint" id="outText"></div>

      <details>
        <summary id="t_testSummary">Test my current settings (optional)</summary>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label id="t_curLowLabel">My current Low cut</label>
            <input id="curLow" inputmode="numeric" placeholder="e.g., 120" />
          </div>
          <div class="col">
            <label id="t_curHighLabel">My current High cut</label>
            <input id="curHigh" inputmode="numeric" placeholder="e.g., 700" />
          </div>
        </div>
        <div class="mini-actions" style="margin-top:10px">
          <button class="btn secondary" id="btnTest">Analyse my current</button>
          <button class="btn secondary" id="btnCopy">Copy suggested range</button>
        </div>
        <div class="small" id="testOut" style="margin-top:10px"></div>
      </details>
    </div>

    <!-- Add to Home Screen -->
    <div class="card">
      <div style="font-weight:980" id="t_a2hsTitle">Add to Home Screen</div>
      <div class="small" id="t_a2hsHint" style="margin-top:6px">Make it one-tap like an app. No login.</div>

      <details style="margin-top:10px">
        <summary id="t_androidTitle">Android (Chrome / Samsung Internet)</summary>
        <div class="steps">
          <div class="step"><div class="num">1</div><div id="t_android1">Open this page in your browser.</div></div>
          <div class="step"><div class="num">2</div><div id="t_android2">Tap the menu (â‹®) or (â˜°).</div></div>
          <div class="step"><div class="num">3</div><div id="t_android3"><b>Add to Home screen</b>.</div></div>
          <div class="step"><div class="num">4</div><div id="t_android4">Confirm. Now it appears like an app icon.</div></div>
        </div>
      </details>

      <details style="margin-top:10px">
        <summary id="t_iphoneTitle">iPhone (Safari)</summary>
        <div class="steps">
          <div class="step"><div class="num">1</div><div id="t_iphone1">Open this page in <b>Safari</b> (not inside another app).</div></div>
          <div class="step"><div class="num">2</div><div id="t_iphone2">Tap the Share icon (â–¡â†‘).</div></div>
          <div class="step"><div class="num">3</div><div id="t_iphone3"><b>Add to Home Screen</b>.</div></div>
          <div class="step"><div class="num">4</div><div id="t_iphone4">Confirm. Now itâ€™s one tap from your home screen.</div></div>
        </div>
      </details>
    </div>

    <div class="footer" id="t_footer">
      General guidance for sound settings. If anything feels uncomfortable, lower volume or stop.
    </div>
  </div>

<script>
  const I18N = {
    en: {
      langBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
      title: "Focus Sound Tool",
      sub: "Select your situation and get a simple sound range suggestion. Works with the Noise Generator app.",
      byline: "By Dr Ushana Yalda",
      quickStart: "Quick start: pick an activity â†’ tap â€œGet my settingâ€.",
      nameLabel: "Name (optional)",
      nameHint: "Tip: add a name so this phone remembers your setup.",
      deviceLabel: "Device (optional)",
      deviceHint: "Device name is for clarity. The next box drives the advice.",
      setupLabel: "Audio setup (this matters)",
      setupPill: "Quick rule: headphones = you can go lower ğŸ§",
      colorLabel: "Noise color",
      colorHint: "If unsure: choose Brown.",
      activityLabel: "Pick an activity",
      activityHint: "Choose one. Keep it simple.",
      btnSuggest: "Get my setting",
      btnSave: "Save my profile",
      btnReset: "Reset (clear saved)",
      autoSaveNote: "Note: â€œGet my settingâ€ also auto-saves your last choices on this phone.",
      outLowK: "Suggested Low cut",
      outHighK: "Suggested High cut",
      outVolK: "Volume hint",
      testSummary: "Test my current settings (optional)",
      curLowLabel: "My current Low cut",
      curHighLabel: "My current High cut",
      btnTest: "Analyse my current",
      btnCopy: "Copy suggested range",
      footer: "General guidance for sound settings. If anything feels uncomfortable, lower volume or stop.",
      placeholders: {
        name: "e.g., Ali / Dalila / Noor",
        device: "e.g., iPhone 11 / Xiaomi / Galaxy...",
        curLow: "e.g., 120",
        curHigh: "e.g., 700"
      },
      setupOptions: [
        ["phone_small", "Phone speaker (small / budget)"],
        ["phone_good",  "Phone speaker (good / flagship)"],
        ["tablet",      "Tablet speaker"],
        ["external",    "External speaker"],
        ["headphones",  "Headphones / earbuds"]
      ],
      colorOptions: [
        ["brown", "Brown (default, warmer)"],
        ["pink",  "Pink (slightly brighter)"]
      ],
      activities: [
        ["work","Work"],
        ["study","Study"],
        ["picnic","Picnic with family"],
        ["walk","Walking alone"],
        ["cooking","Cooking"],
        ["chores","House chores"],
        ["meals","Family meal time"],
        ["tv","Watching TV"],
        ["sleep","Sleep"],
        ["relax","Relax"],
        ["body","Body immersion"]
      ],
      savedMsg: "Saved âœ… (on this phone only)",
      resetConfirm: "Reset saved data on this phone? This cannot be undone.",
      resetDone: "Reset complete âœ…",
      copyFail: (txt)=>`Copy failed. Suggested range: ${txt}`,
      copiedMsg: (txt)=>`Copied: ${txt}`,
      errors: {
        addBoth: "Add both numbers (Low + High) and try again.",
        highHigher: "High must be higher than Low."
      },
      outBlocks: {
        chosen: "Chosen:",
        goal: "Goal:",
        micro: "Micro-adjust:",
        microFallback: "If it feels wrong, change only one thing: volume first.",
        rule: "Rule of thumb: if youâ€™re unsure, keep volume lower and donâ€™t chase â€œperfect.â€"
      },
      quickQ: {
        title: "Quick setup helper (1 question)",
        text: "Set Low cut to 80 Hz for 5 seconds. Do you clearly hear a difference?",
        note: "If you are using headphones/earbuds now, skip this (choose â€œHeadphones / earbudsâ€ above).",
        yes: "Yes â†’ my speaker handles bass",
        no: "No â†’ my speaker is weak",
        setGood: "Set to: Phone speaker (good / flagship).",
        setSmall: "Set to: Phone speaker (small / budget).",
        skip: "You selected headphones/earbuds â€” this test is not needed."
      }
    },
    ar: {
      langBtn: "English",
      title: "Ø£Ø¯Ø§Ø© Ø§Ù„ØµÙˆØª Ù„Ù„ØªØ±ÙƒÙŠØ²",
      sub: "Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø³ÙŠØ· Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙˆØª. ØªØ¹Ù…Ù„ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡.",
      byline: "Ø¨ÙˆØ§Ø³Ø·Ø© Ø¯. Ø§ÙˆØ´Ø§Ù†Ø§ ÙŠÙ„Ø¯Ù‡",
      quickStart: "Ø¨Ø¯Ø§ÙŠØ© Ø³Ø±ÙŠØ¹Ø©: Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· â†’ Ø§Ø¶ØºØ· Â«Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Â».",
      nameLabel: "Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      nameHint: "Ù†ØµÙŠØ­Ø©: Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ù„ÙƒÙŠ ÙŠØªØ°ÙƒØ± Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ø¹Ø¯Ø§Ø¯Ùƒ.",
      deviceLabel: "Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      deviceHint: "Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„ØªÙˆØ¶ÙŠØ­ ÙÙ‚Ø·. Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­.",
      setupLabel: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ù…Ù‡Ù…Ù‘Ø©)",
      setupPill: "Ù‚Ø§Ø¹Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©: Ø§Ù„Ø³Ù…Ø§Ø¹Ø§Øª = ÙŠÙ…ÙƒÙ† Ø®ÙØ¶ Ø§Ù„ØªØ±Ø¯Ø¯ Ø£ÙƒØ«Ø± ğŸ§",
      colorLabel: "Ù†ÙˆØ¹ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡",
      colorHint: "Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ù‹Ø§: Ø§Ø®ØªØ± Ø¨Ù†ÙŠ.",
      activityLabel: "Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø·",
      activityHint: "Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙ‚Ø·. Ø®ÙÙ‘ÙÙ‡Ø§.",
      btnSuggest: "Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯",
      btnSave: "Ø§Ø­ÙØ¸ Ù…Ù„ÙÙŠ",
      btnReset: "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· (Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸)",
      autoSaveNote: "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø²Ø± Â«Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Â» ÙŠØ­ÙØ¸ Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø±Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ.",
      outLowK: "Ø§Ù„Ø­Ø¯Ù‘ Ø§Ù„Ø£Ø¯Ù†Ù‰ (Low cut)",
      outHighK: "Ø§Ù„Ø­Ø¯Ù‘ Ø§Ù„Ø£Ø¹Ù„Ù‰ (High cut)",
      outVolK: "Ù†ØµÙŠØ­Ø© Ù„Ù„ØµÙˆØª",
      testSummary: "Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      curLowLabel: "Ø§Ù„Ø­Ø¯Ù‘ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ",
      curHighLabel: "Ø§Ù„Ø­Ø¯Ù‘ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ",
      btnTest: "Ø­Ù„Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙŠ",
      btnCopy: "Ø§Ù†Ø³Ø® Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­",
      footer: "Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª. Ø¥Ø°Ø§ Ø³Ø¨Ø¨ Ø£ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ø²Ø¹Ø§Ø¬Ù‹Ø§ØŒ Ø®ÙÙ‘Ø¶ Ø§Ù„ØµÙˆØª Ø£Ùˆ ØªÙˆÙ‚Ù.",
      placeholders: {
        name: "Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ / Ø¯Ù„ÙŠÙ„Ø© / Ù†ÙˆØ±",
        device: "Ù…Ø«Ø§Ù„: iPhone 11 / Xiaomi / Galaxy...",
        curLow: "Ù…Ø«Ø§Ù„: 120",
        curHigh: "Ù…Ø«Ø§Ù„: 700"
      },
      setupOptions: [
        ["phone_small", "Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù‡Ø§ØªÙ (Ø¶Ø¹ÙŠÙØ©/Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©)"],
        ["phone_good",  "Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù‡Ø§ØªÙ (Ø¬ÙŠØ¯Ø©/Ù‚ÙˆÙŠØ©)"],
        ["tablet",      "Ø³Ù…Ø§Ø¹Ø© Ø§Ù„ØªØ§Ø¨Ù„Øª"],
        ["external",    "Ø³Ù…Ø§Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ©"],
        ["headphones",  "Ø³Ù…Ø§Ø¹Ø§Øª/Ø¥ÙŠØ±Ø¨ÙˆØ¯Ø²"]
      ],
      colorOptions: [
        ["brown", "Ø¨Ù†ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ø£Ø¯ÙØ£)"],
        ["pink",  "ÙˆØ±Ø¯ÙŠ (Ø£ÙˆØ¶Ø­ Ù‚Ù„ÙŠÙ„Ù‹Ø§)"]
      ],
      activities: [
        ["work","Ø¹Ù…Ù„"],
        ["study","Ø¯Ø±Ø§Ø³Ø©"],
        ["picnic","Ù†Ø²Ù‡Ø© Ù…Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©"],
        ["walk","Ù…Ø´ÙŠ Ù„ÙˆØ­Ø¯ÙŠ"],
        ["cooking","Ø·Ø¨Ø®"],
        ["chores","Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù†Ø²Ù„"],
        ["meals","ÙˆÙ‚Øª Ø§Ù„ÙˆØ¬Ø¨Ø© Ù…Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©"],
        ["tv","Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ØªÙ„ÙØ§Ø²"],
        ["sleep","Ù†ÙˆÙ…"],
        ["relax","Ø§Ø³ØªØ±Ø®Ø§Ø¡"],
        ["body","Body immersion"]
      ],
      savedMsg: "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ ÙÙ‚Ø·)",
      resetConfirm: "Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.",
      resetDone: "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· âœ…",
      copyFail: (txt)=>`ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®. Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${txt}`,
      copiedMsg: (txt)=>`ØªÙ… Ø§Ù„Ù†Ø³Ø®: ${txt}`,
      errors: {
        addBoth: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠÙ† (Low Ùˆ High) Ø«Ù… Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
        highHigher: "ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† High Ø£ÙƒØ¨Ø± Ù…Ù† Low."
      },
      outBlocks: {
        chosen: "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±:",
        goal: "Ø§Ù„Ù‡Ø¯Ù:",
        micro: "ØªØ¹Ø¯ÙŠÙ„ Ø³Ø±ÙŠØ¹:",
        microFallback: "Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø§Ø³Ø¨ÙƒØŒ ØºÙŠÙ‘Ø± Ø´ÙŠØ¦Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙ‚Ø·: Ø®ÙÙ‘Ø¶/Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ù‹Ø§.",
        rule: "Ù‚Ø§Ø¹Ø¯Ø©: Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø­ØªØ§Ø±Ù‹Ø§ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØª Ø£Ù‚Ù„ ÙˆÙ„Ø§ ØªÙ„Ø§Ø­Ù‚ â€œØ§Ù„Ù…Ø«Ø§Ù„ÙŠâ€."
      },
      quickQ: {
        title: "Ù…Ø³Ø§Ø¹Ø¯ Ø³Ø±ÙŠØ¹ (Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯)",
        text: "Ø§Ø¶Ø¨Ø· Low cut Ø¹Ù„Ù‰ 80 Hz Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†Ù. Ù‡Ù„ ØªØ³Ù…Ø¹ ÙØ±Ù‚Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ØŸ",
        note: "Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ø³Ù…Ø§Ø¹Ø§Øª/Ø¥ÙŠØ±Ø¨ÙˆØ¯Ø² Ø§Ù„Ø¢Ù†ØŒ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ (Ø§Ø®ØªØ± Â«Ø³Ù…Ø§Ø¹Ø§Øª/Ø¥ÙŠØ±Ø¨ÙˆØ¯Ø²Â» Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰).",
        yes: "Ù†Ø¹Ù… â†’ Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² ØªØªØ­Ù…Ù„ Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©",
        no: "Ù„Ø§ â†’ Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¶Ø¹ÙŠÙØ©",
        setGood: "ØªÙ… Ø§Ù„Ø¶Ø¨Ø· Ø¥Ù„Ù‰: Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù‡Ø§ØªÙ (Ø¬ÙŠØ¯Ø©/Ù‚ÙˆÙŠØ©).",
        setSmall: "ØªÙ… Ø§Ù„Ø¶Ø¨Ø· Ø¥Ù„Ù‰: Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù‡Ø§ØªÙ (Ø¶Ø¹ÙŠÙØ©/Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©).",
        skip: "Ø£Ù†Øª Ø§Ø®ØªØ±Øª Ø³Ù…Ø§Ø¹Ø§Øª/Ø¥ÙŠØ±Ø¨ÙˆØ¯Ø² â€” Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±."
      }
    }
  };

  let lang = "en";
  const $ = (id)=>document.getElementById(id);

  function fillSelect(el, options){
    el.innerHTML = "";
    for(const [val, text] of options){
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = text;
      el.appendChild(opt);
    }
  }

  // Core recommendation logic
  const BASE = {
    work:   { low:120, high:850, vol:{en:"Lowâ€“medium", ar:"Ù…Ù†Ø®ÙØ¶â€“Ù…ØªÙˆØ³Ø·"}, why:{
      en:"Focus + calm. Reduce internal chatter but keep alert.",
      ar:"ØªØ±ÙƒÙŠØ² ÙˆÙ‡Ø¯ÙˆØ¡. ÙŠÙ‚Ù„Ù„ Ø¶Ø¬ÙŠØ¬ Ø§Ù„Ø£ÙÙƒØ§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ‚Ø¸Ø©."
    }},
    study:  { low:150, high:700, vol:{en:"Lowâ€“medium", ar:"Ù…Ù†Ø®ÙØ¶â€“Ù…ØªÙˆØ³Ø·"}, why:{
      en:"Sustained focus. Slightly narrower band to stay steady.",
      ar:"ØªØ±ÙƒÙŠØ² Ù…Ø³ØªÙ…Ø±. Ù†Ø·Ø§Ù‚ Ø£Ø¶ÙŠÙ‚ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ø«Ø¨Ø§Øª Ø£ÙØ¶Ù„."
    }},
    picnic: { low:120, high:950, vol:{en:"Low", ar:"Ù…Ù†Ø®ÙØ¶"}, why:{
      en:"Soften overstimulation. Keep it gentle so you can still connect.",
      ar:"ÙŠØ®ÙÙ ÙØ±Ø· Ø§Ù„ØªØ­ÙÙŠØ². Ø§Ø¬Ø¹Ù„Ù‡ Ù„Ø·ÙŠÙÙ‹Ø§ ÙƒÙŠ ØªØ¨Ù‚Ù‰ Ù…ØªØµÙ„Ù‹Ø§ Ø¨Ø§Ù„Ù†Ø§Ø³."
    }},
    walk:   { low:130, high:900, vol:{en:"Low", ar:"Ù…Ù†Ø®ÙØ¶"}, why:{
      en:"Grounded + aware. Not too immersive.",
      ar:"Ø«Ø¨Ø§Øª Ù…Ø¹ Ø§Ù†ØªØ¨Ø§Ù‡. Ø¨Ø¯ÙˆÙ† Ø§Ù†Ø¯Ù…Ø§Ø¬ Ø²Ø§Ø¦Ø¯."
    }},
    cooking:{ low:160, high:1000,vol:{en:"Lowâ€“medium", ar:"Ù…Ù†Ø®ÙØ¶â€“Ù…ØªÙˆØ³Ø·"}, why:{
      en:"Rhythm + momentum. Helps you stay engaged without zoning out.",
      ar:"Ø¥ÙŠÙ‚Ø§Ø¹ ÙˆØ­Ø±ÙƒØ©. ÙŠØ³Ø§Ø¹Ø¯Ùƒ ØªØ¨Ù‚Ù‰ Ø­Ø§Ø¶Ø± Ø¨Ø¯ÙˆÙ† ØªØ´ØªØª."
    }},
    chores: { low:180, high:1100,vol:{en:"Medium", ar:"Ù…ØªÙˆØ³Ø·"}, why:{
      en:"Energy + movement. A bit wider to keep momentum.",
      ar:"Ø·Ø§Ù‚Ø© ÙˆØ­Ø±ÙƒØ©. Ù†Ø·Ø§Ù‚ Ø£ÙˆØ³Ø¹ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±."
    }},
    meals:  { low:140, high:800, vol:{en:"Very low", ar:"Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§"}, why:{
      en:"Buffer triggers. Light background only.",
      ar:"ÙŠØ®ÙÙ Ø§Ù„Ù…Ø­ÙØ²Ø§Øª. Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© ÙÙ‚Ø·."
    }},
    tv:     { low:200, high:650, vol:{en:"Very low", ar:"Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§"}, why:{
      en:"Keep dialogue clear. Light thought-softener.",
      ar:"ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆØ¶ÙˆØ­ Ø§Ù„ÙƒÙ„Ø§Ù…. Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„ØªÙ„ÙŠÙŠÙ† Ø§Ù„ØªÙÙƒÙŠØ±."
    }},
    sleep:  { low:90,  high:1200,vol:{en:"Low", ar:"Ù…Ù†Ø®ÙØ¶"}, why:{
      en:"Mask intermittent noise. Wider band for blocking.",
      ar:"ÙŠØ­Ø¬Ø¨ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ØªÙ‚Ø·Ø¹Ø©. Ù†Ø·Ø§Ù‚ Ø£ÙˆØ³Ø¹ Ù„Ù„ØªÙ…ÙˆÙŠÙ‡."
    }},
    relax:  { low:110, high:950, vol:{en:"Low", ar:"Ù…Ù†Ø®ÙØ¶"}, why:{
      en:"Decompress. Gentle and supportive.",
      ar:"ØªÙ‡Ø¯Ø¦Ø© ÙˆØªÙØ±ÙŠØº. Ù„Ø·ÙŠÙ ÙˆÙ…Ø±ÙŠØ­."
    }},
    body:   { low:100, high:700, vol:{en:"Low", ar:"Ù…Ù†Ø®ÙØ¶"}, why:{
      en:"Less thinking, more presence. Smooth, not too wide.",
      ar:"ØªÙÙƒÙŠØ± Ø£Ù‚Ù„ ÙˆØ­Ø¶ÙˆØ± Ø£ÙƒØ«Ø±. Ù†Ø§Ø¹Ù… ÙˆÙ„ÙŠØ³ ÙˆØ§Ø³Ø¹Ù‹Ø§ Ø¬Ø¯Ù‹Ø§."
    }}
  };

  const SETUP_ADJ = {
    phone_small: { lowMin:160, lowLift:+30, highClamp:1200 },
    phone_good:  { lowMin:120, lowLift:+0,  highClamp:1400 },
    tablet:      { lowMin:110, lowLift:-10, highClamp:1600 },
    external:    { lowMin:90,  lowLift:-20, highClamp:2000 },
    headphones:  { lowMin:70,  lowLift:-30, highClamp:3000 }
  };

  function applyColor(high, color){
    if(color === "pink") return Math.max(450, Math.round(high * 0.9));
    return high;
  }

  function computeSuggestion(activityId, setupId, color){
    const base = BASE[activityId];
    const adj = SETUP_ADJ[setupId];

    let low = base.low + adj.lowLift;
    low = Math.max(low, adj.lowMin);

    let high = Math.min(base.high, adj.highClamp);

    if(high - low < 350) high = low + 350;
    high = applyColor(high, color);

    low = Math.round(low / 10) * 10;
    high = Math.round(high / 10) * 10;

    if(setupId.startsWith("phone") && low < 120) low = 120;
    if(setupId === "phone_small" && low < 160) low = 160;
    if(high - low < 350) high = low + 350;

    return { low, high, vol: base.vol[lang], why: base.why[lang] };
  }

  // UI state
  let activeActivity = "work";

  function renderChips(){
    const chips = $("chips");
    chips.innerHTML = "";
    const acts = I18N[lang].activities;
    for(const [id, label] of acts){
      const div = document.createElement("div");
      div.className = "chip" + (id === activeActivity ? " active" : "");
      div.textContent = label;
      div.onclick = () => { activeActivity = id; renderChips(); };
      chips.appendChild(div);
    }
  }

  function applyLang(){
    const t = I18N[lang];

    document.documentElement.lang = (lang === "ar" ? "ar" : "en");
    document.documentElement.dir = (lang === "ar" ? "rtl" : "ltr");

    $("btnLang").textContent = t.langBtn;

    $("t_title").textContent = t.title;
    $("t_sub").textContent = t.sub;
    $("t_byline").textContent = t.byline;
    $("t_quickStart").textContent = t.quickStart;

    $("t_nameLabel").textContent = t.nameLabel;
    $("t_nameHint").textContent = t.nameHint;
    $("t_deviceLabel").textContent = t.deviceLabel;
    $("t_deviceHint").textContent = t.deviceHint;

    $("t_setupLabel").textContent = t.setupLabel;
    $("t_setupPill").textContent = t.setupPill;

    $("t_colorLabel").textContent = t.colorLabel;
    $("t_colorHint").textContent = t.colorHint;

    // Quick question area
    $("t_qTitle").textContent = t.quickQ.title;
    $("t_qText").childNodes[0].nodeValue = t.quickQ.text + " ";
    $("t_qNote").textContent = t.quickQ.note;
    $("btnQYes").textContent = t.quickQ.yes;
    $("btnQNo").textContent = t.quickQ.no;

    $("t_activityLabel").textContent = t.activityLabel;
    $("t_activityHint").textContent = t.activityHint;

    $("btnSuggest").textContent = t.btnSuggest;
    $("btnSave").textContent = t.btnSave;
    $("btnReset").textContent = t.btnReset;

    $("t_autoSaveNote").textContent = t.autoSaveNote;

    $("t_outLowK").textContent = t.outLowK;
    $("t_outHighK").textContent = t.outHighK;
    $("t_outVolK").textContent = t.outVolK;

    $("t_testSummary").textContent = t.testSummary;
    $("t_curLowLabel").textContent = t.curLowLabel;
    $("t_curHighLabel").textContent = t.curHighLabel;
    $("btnTest").textContent = t.btnTest;
    $("btnCopy").textContent = t.btnCopy;

    $("t_footer").textContent = t.footer;

    $("name").placeholder = t.placeholders.name;
    $("device").placeholder = t.placeholders.device;
    $("curLow").placeholder = t.placeholders.curLow;
    $("curHigh").placeholder = t.placeholders.curHigh;

    // selects (preserve)
    const setupSel = $("setup");
    const prevSetup = setupSel.value || "phone_small";
    fillSelect(setupSel, t.setupOptions);
    setupSel.value = prevSetup;

    const colorSel = $("color");
    const prevColor = colorSel.value || "brown";
    fillSelect(colorSel, t.colorOptions);
    colorSel.value = prevColor;

    renderChips();
  }

  function showSuggestion({autosave=true} = {}){
    const setupId = $("setup").value;
    const color = $("color").value;
    const s = computeSuggestion(activeActivity, setupId, color);

    $("outLow").textContent = s.low + " Hz";
    $("outHigh").textContent = s.high + " Hz";
    $("outVol").textContent = s.vol;

    const t = I18N[lang];
    const activityLabel = (t.activities.find(x=>x[0]===activeActivity) || ["", ""])[1];
    const setupLabel = (t.setupOptions.find(x=>x[0]===setupId) || ["", ""])[1];
    const colorLabel = (t.colorOptions.find(x=>x[0]===color) || ["", ""])[1];

    const miniRules = [];
    if(setupId === "phone_small"){
      miniRules.push(lang==="ar"
        ? "Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙˆØª (Ø§Ù‡ØªØ²Ø§Ø²/Ø«ÙÙ‚Ù„) Ø£Ùˆ Ø¶Ø¹ÙŠÙÙ‹Ø§ â†’ Ø§Ø±ÙØ¹ Low cut Ø¨Ù…Ù‚Ø¯Ø§Ø± 20â€“40 Hz."
        : "If it feels â€˜rumblyâ€™ or weak â†’ raise Low cut by 20â€“40 Hz."
      );
    }
    if(setupId === "headphones"){
      miniRules.push(lang==="ar"
        ? "Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù†Ø¯Ù…Ø§Ø¬Ù‹Ø§ Ø²Ø§Ø¦Ø¯Ù‹Ø§ â†’ Ø§Ø±ÙØ¹ Low cut Ø¨Ù…Ù‚Ø¯Ø§Ø± 10â€“20 Hz Ø£Ùˆ Ø§Ø®ÙØ¶ Ø§Ù„ØµÙˆØª."
        : "If it feels too immersive â†’ raise Low cut by 10â€“20 Hz or lower volume."
      );
    }
    if(activeActivity === "tv"){
      miniRules.push(lang==="ar"
        ? "Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„ÙƒÙ„Ø§Ù… ØºÙŠØ± ÙˆØ§Ø¶Ø­ â†’ Ø§Ø®ÙØ¶ Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ù‹Ø§ØŒ Ø«Ù… Ø§Ø±ÙØ¹ Low cut Ø¨Ù…Ù‚Ø¯Ø§Ø± 20 Hz."
        : "If dialogue gets hard â†’ lower volume first. Then raise Low cut by 20 Hz."
      );
    }
    if(activeActivity === "sleep"){
      miniRules.push(lang==="ar"
        ? "Ø¥Ø°Ø§ Ø£Ø¨Ù‚Ø§Ùƒ Ù…Ø³ØªÙŠÙ‚Ø¸Ù‹Ø§ â†’ Ø®ÙÙ‘Ø¶ High cut Ø¨Ù…Ù‚Ø¯Ø§Ø± 100â€“200 Hz."
        : "If it keeps you awake â†’ lower High cut by 100â€“200 Hz."
      );
    }
    if(color === "pink"){
      miniRules.push(lang==="ar"
        ? "Ø§Ù„ÙˆØ±Ø¯ÙŠ Ù‚Ø¯ ÙŠØ¨Ø¯Ùˆ Ø£ÙˆØ¶Ø­/Ø£Ø­Ø¯Ù‘. Ø¥Ø°Ø§ ØµØ§Ø± Ù…Ø²Ø¹Ø¬Ù‹Ø§ â†’ Ø®ÙÙ‘Ø¶ High cut Ø¨Ù…Ù‚Ø¯Ø§Ø± 100 Hz."
        : "Pink can feel brighter. If edgy â†’ lower High cut by 100 Hz."
      );
    }

    const microHtml = miniRules.length
      ? "<ul style='margin:6px 0 0 18px;padding:0'>" + miniRules.map(r=>`<li>${r}</li>`).join("") + "</ul>"
      : t.outBlocks.microFallback;

    $("outText").innerHTML = `
  <div><span class="flag ok">${t.outBlocks.chosen}</span> <b>${activityLabel}</b> â€¢ <span class="flag">${setupLabel}</span> â€¢ <span class="flag">${colorLabel}</span></div>
  <div style="margin-top:8px"><span class="flag ok">${t.outBlocks.goal}</span> ${s.why}</div>
  <div style="margin-top:8px"><span class="flag warn">${t.outBlocks.micro}</span> ${microHtml}</div>
  <div style="margin-top:8px" class="small">${t.outBlocks.rule}</div>
  <div style="margin-top:10px" class="small"><span class="flag ok">${t.signature}</span></div>
`;

    $("resultCard").style.display = "flex";
    $("testOut").textContent = "";

    if(autosave) autoSaveLast();
  }

  // Storage (no "family")
  function profileKey(){
    const n = ($("name").value || "").trim().toLowerCase();
    return n ? ("soundtool_profile_" + n) : "soundtool_profile_default";
  }

  function saveProfile(){
    const t = I18N[lang];
    const data = {
      name: $("name").value.trim(),
      device: $("device").value.trim(),
      setup: $("setup").value,
      color: $("color").value,
      activity: activeActivity,
      lang: lang,
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(profileKey(), JSON.stringify(data));
    localStorage.setItem("soundtool_last_profile_key", profileKey());
    alert(t.savedMsg);
  }

  function autoSaveLast(){
    const data = {
      name: $("name").value.trim(),
      device: $("device").value.trim(),
      setup: $("setup").value,
      color: $("color").value,
      activity: activeActivity,
      lang: lang,
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(profileKey(), JSON.stringify(data));
    localStorage.setItem("soundtool_last_profile_key", profileKey());
  }

  function loadProfile(){
    const lastKey = localStorage.getItem("soundtool_last_profile_key") || "soundtool_profile_default";
    const raw = localStorage.getItem(lastKey);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      $("name").value = data.name || "";
      $("device").value = data.device || "";
      $("setup").value = data.setup || "phone_small";
      $("color").value = data.color || "brown";
      activeActivity = data.activity || "work";
      if(data.lang === "ar" || data.lang === "en") lang = data.lang;
    }catch(e){}
  }

  function resetProfile(){
    const t = I18N[lang];
    if(!confirm(t.resetConfirm)) return;

    const key = profileKey();
    localStorage.removeItem(key);

    const lastKey = localStorage.getItem("soundtool_last_profile_key");
    if(lastKey === key) localStorage.removeItem("soundtool_last_profile_key");

    $("name").value = "";
    $("device").value = "";
    $("setup").value = "phone_small";
    $("color").value = "brown";
    activeActivity = "work";
    renderChips();

    $("resultCard").style.display = "none";
    $("curLow").value = "";
    $("curHigh").value = "";
    $("testOut").textContent = "";
    $("qResult").textContent = "";

    alert(t.resetDone);
  }

  // Quick setup helper (1 question)
  function quickSetFromAnswer(isYes){
    const t = I18N[lang];
    const currentSetup = $("setup").value;

    if(currentSetup === "headphones"){
      $("qResult").innerHTML = `<span class="ok flag">${t.quickQ.skip}</span>`;
      return;
    }

    if(isYes){
      $("setup").value = "phone_good";
      $("qResult").innerHTML = `<span class="ok flag">${t.quickQ.setGood}</span>`;
    }else{
      $("setup").value = "phone_small";
      $("qResult").innerHTML = `<span class="warn flag">${t.quickQ.setSmall}</span>`;
    }

    // gentle autosave so they don't lose it
    autoSaveLast();
  }

  // Analyse current settings
  function toSafeInt(v){
    if(typeof v !== "string") return NaN;
    const cleaned = v.replace(/[^\d\-]/g, "");
    const n = parseInt(cleaned, 10);
    return Number.isFinite(n) ? n : NaN;
  }

  function analyseCurrent(){
    const t = I18N[lang];
    const s = computeSuggestion(activeActivity, $("setup").value, $("color").value);

    const lo = toSafeInt($("curLow").value);
    const hi = toSafeInt($("curHigh").value);

    if(Number.isNaN(lo) || Number.isNaN(hi)){
      $("testOut").innerHTML = `<span class="bad flag">${t.errors.addBoth}</span>`;
      return;
    }
    if(hi <= lo){
      $("testOut").innerHTML = `<span class="bad flag">${t.errors.highHigher}</span>`;
      return;
    }

    const bandwidth = hi - lo;
    const notes = [];
    const setupId = $("setup").value;

    if(setupId === "phone_small" && lo < 150){
      notes.push(lang==="ar"
        ? `<span class="warn flag">Low cut Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§</span> Ù„Ø³Ù…Ø§Ø¹Ø© Ù‡Ø§ØªÙ Ø¶Ø¹ÙŠÙØ© â†’ Ù‚Ø¯ ØªØ³Ù…Ø¹ Ø§Ù‡ØªØ²Ø§Ø² Ø£Ùˆ â€œÙ„Ø§ ÙØ±Ù‚â€. Ø¬Ø±Ù‘Ø¨ <b>${Math.max(160, lo+20)} Hz</b> Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­ <b>${s.low} Hz</b>.`
        : `<span class="warn flag">Low cut too low</span> for a small phone speaker â†’ rumble or â€œno effectâ€. Try <b>${Math.max(160, lo+20)} Hz</b> or use <b>${s.low} Hz</b>.`
      );
    }

    const targetBW = (function(){
      switch(activeActivity){
        case "study": return {min:350, max:650};
        case "work": return {min:350, max:850};
        case "tv": return {min:250, max:550};
        case "sleep": return {min:700, max:1400};
        case "meals": return {min:300, max:700};
        case "body": return {min:350, max:750};
        default: return {min:350, max:1100};
      }
    })();

    if(bandwidth < targetBW.min){
      notes.push(lang==="ar"
        ? `<span class="warn flag">Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¶ÙŠÙ‚</span> (${bandwidth} Hz). ÙˆØ³Ù‘Ø¹ Ø§Ù„Ù†Ø·Ø§Ù‚ (Ø§Ø±ÙØ¹ High Ø£Ùˆ Ø§Ø®ÙØ¶ Low Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯).`
        : `<span class="warn flag">Band too narrow</span> (${bandwidth} Hz). Widen it (raise High or lower Low safely).`
      );
    } else if(bandwidth > targetBW.max){
      notes.push(lang==="ar"
        ? `<span class="warn flag">Ø§Ù„Ù†Ø·Ø§Ù‚ ÙˆØ§Ø³Ø¹ Ø¬Ø¯Ù‹Ø§</span> (${bandwidth} Hz). Ø¶ÙŠÙ‘Ù‚Ù‡ Ù‚Ù„ÙŠÙ„Ù‹Ø§ (ØºØ§Ù„Ø¨Ù‹Ø§ Ø®ÙÙ‘Ø¶ High).`
        : `<span class="warn flag">Band very wide</span> (${bandwidth} Hz). Narrow it a bit (often lower High).`
      );
    } else {
      notes.push(lang==="ar"
        ? `<span class="ok flag">Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø·Ø§Ù‚ Ù…Ù†Ø§Ø³Ø¨</span> Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·.`
        : `<span class="ok flag">Band width looks reasonable</span> for this activity.`
      );
    }

    notes.push(lang==="ar"
      ? `Ø§Ù„Ù…Ù‚ØªØ±Ø­: <b>${s.low}â€“${s.high} Hz</b>. Ø¥Ø¹Ø¯Ø§Ø¯Ùƒ: <b>${lo}â€“${hi} Hz</b>.`
      : `Suggested: <b>${s.low}â€“${s.high} Hz</b>. You: <b>${lo}â€“${hi} Hz</b>.`
    );

    $("testOut").innerHTML = `<div class="small">${notes.map(n=>`â€¢ ${n}`).join("<br>")}</div>`;
  }

  async function copySuggested(){
    const s = computeSuggestion(activeActivity, $("setup").value, $("color").value);
    const txt = `${s.low}-${s.high} Hz`;
    try{
      await navigator.clipboard.writeText(txt);
      alert(I18N[lang].copiedMsg(txt));
    }catch(e){
      alert(I18N[lang].copyFail(txt));
    }
  }

  // Events + init
  $("btnSuggest").onclick = () => showSuggestion({autosave:true});
  $("btnSave").onclick = saveProfile;
  $("btnReset").onclick = resetProfile;
  $("btnTest").onclick = analyseCurrent;
  $("btnCopy").onclick = copySuggested;

  $("btnQYes").onclick = () => quickSetFromAnswer(true);
  $("btnQNo").onclick = () => quickSetFromAnswer(false);

  $("btnLang").onclick = () => {
    lang = (lang === "en") ? "ar" : "en";
    applyLang();
    if($("resultCard").style.display !== "none") showSuggestion({autosave:true});
  };

  applyLang();
  loadProfile();
  applyLang();
  renderChips();
</script>
</body>
</html>
